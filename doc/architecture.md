# PLC / SCADA 学習用シミュレータ 技術資料

本資料は、本リポジトリに含まれる **PLC / デバイス / Modbus シミュレータの実装内容** をもとに、
設定ファイル（YAML）をどのように記述すればよいかを理解してもらうことを目的としています。



## 1. 基本機能方針

本シミュレータは、以下の方針で実装されています。

* PLC の **スキャン方式** を再現する
* PLC の **メモリ構造（X / Y / M / D）** を明示的に扱う
* SCADA との接続を想定し **Modbus/TCP** に対応する
* 実機がなくても **PLC とデバイスの信号の流れを体験できる**
* YAML による **設定駆動** を前提とする

本シミュレータは **実機 PLC の完全再現** を目的としたものではなく、
SCADA 開発や PLC データ取得の理解を目的とした学習用実装です。



## 2. システム全体構成

```
[Device Simulator]
        │  (Modbus TCP)
        ▼
[PLC Simulator]
        │
        ├─ スキャン処理
        ├─ ラダー評価
        └─ メモリ更新 (X / Y / M / D)
```

* **Device Simulator**
  センサーやスイッチを模した信号を PLC に送信する

* **PLC Simulator**
  受信した入力をもとにラダーを評価し、出力を更新する

* **Modbus/TCP**
  PLC とデバイス間の通信手段



## 3. PLC 機能の内容

### 3.1 PLC メモリモデル

PLC 内部では以下のメモリを保持しています。

| 種類 | 説明              |
| -- |  |
| X  | 外部入力（スイッチ・センサー） |
| Y  | 外部出力            |
| M  | 内部リレー           |
| D  | データレジスタ（整数値）    |

メモリサイズは `plc.yaml` で指定します。

```yaml
memory:
  X: 16
  Y: 16
  M: 64
  D: 32
```



### 3.2 スキャン処理

PLC は以下の処理を **スキャンサイクルごとに繰り返します**。

1. Modbus 経由で X（入力）を更新
2. ラダーを上から順に評価
3. Y / M / D を更新
4. Modbus 側へ出力を反映

スキャン周期は `plc.yaml` で指定します。

```yaml
cpu:
  scan_cycle_ms: 100
```



## 4. Modbus 機能の内容

### 4.1 対応プロトコル

* Modbus/TCP
* `pymodbus` を使用

### 4.2 PLC メモリとの対応関係

| Modbus 種別        | PLC メモリ    |
| - | - |
| Coil (0～)        | X（入力）      |
| Coil (20～)       | Y（出力）      |
| Coil (40～)       | M（内部リレー）   |
| Holding Register | D（データレジスタ） |

※ アドレス割当は実装内で固定されています。



### 4.3 通信の方向

* **X**：外部（デバイス） → PLC
* **Y / M / D**：PLC → 外部（SCADA / デバイス）



## 5. デバイス制御機能の内容

### 5.1 Device Simulator の役割

Device Simulator は以下を再現します。

* スイッチ ON / OFF
* センサー値の変動
* 瞬間的なパルス信号

PLC 実機に接続される **外部機器側の挙動** を想定しています。



### 5.2 device.yaml の構成

```yaml
kind: device
version: 1.0

device:
  name: sample_device
  cycle_ms: 100

  plc:
    host: 127.0.0.1
    port: 5020

  signals:
    start_sw:
      type: coil
      address: 0
      pattern:
        - value: true
          duration_ms: 1000
        - value: false
          duration_ms: 1000
```



### 5.3 信号タイプ

| type     | 説明        |
| -- |  |
| coil     | ON/OFF 信号 |
| register | 数値信号      |
| pulse    | 瞬間的なパルス信号 |



## 6. ラダー構文で記述できること

### 6.1 基本ラダー（論理式）

```yaml
- "[X0 AND M0] --(Y0)"
```

* 論理式は `AND / OR / NOT` に対応
* X / M を入力に使用可能
* 出力は Y / M



### 6.2 計算命令（D レジスタ）

```yaml
- "D0 = D1 + D2"
- "D3 = D4 - D5"
- "D6 = D7 * D8"
- "D9 = D10 / D11"
```

対応演算：

| 演算 | 説明 |
| -- | -- |
| +  | 加算 |
| -  | 減算 |
| *  | 乗算 |
| /  | 除算 |



### 6.3 データ転送（MOV）

```yaml
- "D0 = D1"
```



### 6.4 END 命令

```yaml
- "END"
```

* ラダーの終端を明示
* 可読性向上のために使用



## 7. 本シミュレータの狙い

* PLC の「値が流れる感覚」を掴む
* SCADA が PLC から何を取得しているかを理解する
* 不安定な入力・瞬間信号を前提とした設計を体験する



## 8. 注意事項

* 実機 PLC の全命令・挙動は再現していません
* 学習・検証用途を想定しています



## 9. 今後の拡張想定（参考）

* タイマ / カウンタ命令
* 状態遷移イベント化
* 履歴データ蓄積
* SCADA 向けタグ管理
